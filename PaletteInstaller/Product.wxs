<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" >
	<Product Id="d03dd71e-a3c6-4950-b35c-3e518908f9d6" Name="Palette Agent" Language="1033" Version="0.1" Manufacturer="Palette Software" UpgradeCode="ab39a1ce-7e04-42c6-8abe-d30f22fa3eda">
		<Package InstallerVersion="200" Compressed="yes" />
		<Media Id="1" Cabinet="palette.cab" EmbedCab="yes" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLLOCATION" />
    <Property Id="SERVICEACCOUNT" Secure="yes"></Property>
    <Property Id="SERVICEPASSWORD" Secure="yes"></Property>
    <UIRef Id="WixUI_InstallDir_Palette" />
		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="ProgramFilesFolder">
				<Directory Id="INSTALLLOCATION" Name="Palette">
          <!-- TODO: Remove the comments around this Component element and the ComponentRef below in order to add resources to this installer. -->
          <Component Id="Base" Guid="f8e03674-4769-4971-8180-75e968e3064f">
            <!-- TODO: Insert files, registry keys, and other resources here. -->
            <File Id="ConsoleAgent.exe" Source="..\ConsoleAgent\bin\Debug\ConsoleAgent.exe"></File>
            <File Id="fastJSON.dll" Source="..\ConsoleAgent\bin\Debug\fastJSON.dll"></File>
            <File Id="log4net.dll" Source="..\ConsoleAgent\bin\Debug\log4net.dll"></File>
          </Component>
          <Component Id="Service" Guid="a2bcbb04-d079-4423-bfa3-66ce4321f266">
            <File Id="ServiceAgent.exe" Name="ServiceAgent.exe" Source="..\ServiceAgent\bin\Debug\ServiceAgent.exe" DiskId='1' KeyPath='yes' />
            <!--ServiceInstall Id="Palette" Type="ownProcess" Name="Palette" DisplayName="Palette Agent"
                    Description="Service for Palette Agent" Start="auto" Account="LocalSystem" ErrorControl="normal"-->
            <ServiceInstall Id="Palette" Type="ownProcess" Name="Palette" DisplayName="Palette Agent"
                    Description="Service for Palette Agent" Start="auto" Account="[SERVICEACCOUNT]" Password="[SERVICEPASSWORD]" ErrorControl="normal">
              <!--PermissionEx  Sddl="yes" User="Everyone" ServicePauseContinue="yes" ServiceQueryStatus="yes"
                      ServiceStart="yes" ServiceStop="yes" ServiceUserDefinedControl="yes" /-->              
            </ServiceInstall>
            <!--ServiceControl Id="Palette" Start="install" Stop="both" Remove="both" Name="Palette" Wait="no" /-->
            <ServiceControl Id="Palette" Stop="both" Start="install" Remove="uninstall" Name="Palette" Wait="no" />            
          </Component>
          <Directory Id="bin" Name="bin">
            <Component Id="BinFolder" Guid="13d612a4-69a2-4231-b404-09e891e7e44b">
              <!-- TODO: Insert files, registry keys, and other resources here. -->
              <File Id="InstallerHelper.exe" Source="..\InstallerHelper\bin\Debug\InstallerHelper.exe"></File>
              <File Id="pget.exe" Source="..\pget\bin\Debug\pget.exe"></File>
              <File Id="prun.exe" Source="..\prun\bin\Debug\prun.exe"></File>
              <File Id="pinfo.exe" Source="..\pinfo\bin\Debug\pinfo.exe"></File>
            </Component>
          </Directory>
          <Directory Id="log" Name="log">
            <Component Id="LogFolder" Guid="a2bcbb04-d079-4423-bfa3-66ce4321f268">
              <CreateFolder />
              <!--File Id="agent.log" Source="..\conf\agent.log"></File-->
              <RemoveFile Id="RemoveLogFolder" Name="*.*" On="uninstall" />
            </Component>
          </Directory>
          <Directory Id="conf" Name="conf">
            <Component Id="ConfigFolder" Guid="a2bcbb04-d079-4423-bfa3-66ce4321f269">
              <CreateFolder />
              <RemoveFile Id="RemoveConfigFolder" Name="*.*" On="uninstall" />
            </Component>
          </Directory>
          <Directory Id="data" Name="Data">
            <Component Id="DataFolder" Guid="52fa459d-03d6-42ea-bba2-c12036d79162">
              <CreateFolder />
            </Component>
          </Directory>
          <Directory Id="XID" Name="XID">
            <Component Id="XIDFolder" Guid="a2bcbb04-d079-4423-bfa3-66ce4321f270">
              <CreateFolder />
              <!-- TODO: Unfortunately does not delete files recursively. -->
              <RemoveFile Id="RemoveXIDFolder" Name="*.*" On="uninstall" />
            </Component>
          </Directory>
          <Directory Id="docroot" Name="DocRoot">
            <Component Id="DocRootFolder" Guid="2f73bf32-d937-4d3b-9aed-566ff1368958">
              <CreateFolder />
              <File Id="index.html" Source="..\..\maint\www\index.html" />
              <File Id="style.css" Source="..\..\maint\www\style.css" />
              <File Id="palette_logo_600dpi_2.png" Source="..\..\maint\www\palette_logo_600dpi-2.png" />
              <File Id="bg.png" Source="..\..\maint\www\bg.png" />
              <File Id="favicon.ico" Source="..\..\maint\www\favicon.ico" />
              <File Id="favicon60.ico" Source="..\..\maint\www\favicon-60.png" />
              <File Id="favicon76.ico" Source="..\..\maint\www\favicon-76.png" />
              <File Id="favicon120.ico" Source="..\..\maint\www\favicon-120.png" />
              <File Id="favicon152.ico" Source="..\..\maint\www\favicon-152.png" />
            </Component>
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="ProductFeature" Title="Palette" Level="1">
      <!-- TODO: Remove the comments around this ComponentRef element and the Component above in order to add resources to this installer. -->
      <ComponentRef Id="Base" />
      <ComponentRef Id="BinFolder"/>
      <ComponentRef Id="LogFolder" />
      <ComponentRef Id="XIDFolder" />
      <ComponentRef Id="ConfigFolder" />
      <ComponentRef Id="DataFolder" />
      <ComponentRef Id="DocRootFolder" />
      <!-- This ref should be last to ensure the service isn't started before everything is done. -->
      <ComponentRef Id="Service" />
      <!-- Note: The following ComponentGroupRef is required to pull in generated authoring from project references. -->
      <ComponentGroupRef Id="Product.Generated" />
    </Feature>

    <Binary Id="PaletteInstallerCA" SourceFile="..\PaletteInstallerCA\bin\Debug\PaletteInstallerCA.CA.dll" />

    <!-- Immediate CA -->
    <CustomAction Id="CreateIniFileImmediate" Property="CreateIniFile" Value="INSTALLLOCATION=[INSTALLLOCATION];SERVERNAME=[SERVERNAME]" />
    <CustomAction Id="CreatePaletteUserImmediate" Property="CreatePaletteUser" Value="SERVICEACCOUNT=[SERVICEACCOUNT];SERVICEPASSWORD=[SERVICEPASSWORD]"/>
    <CustomAction Id="CreatePaletteUser" Return="check" Execute="immediate" BinaryKey="PaletteInstallerCA" DllEntry="CreatePaletteUser"/>
    <CustomAction Id="HidePaletteUserImmediate" Property="HidePaletteUser" Value="INSTALLLOCATION=[INSTALLLOCATION];"/>
    <CustomAction Id="CleanupAfterUnInstall" Return="check" Execute="immediate" BinaryKey="PaletteInstallerCA" DllEntry="CleanupAfterUnInstall" />
    <CustomAction Id="CleanupOnRollback" Return="check" Execute="rollback" BinaryKey="PaletteInstallerCA" DllEntry="CleanupAfterUnInstall" />
    
    <!-- Deferred CA -->    
    <CustomAction Id="CreateIniFile" Execute="deferred" BinaryKey="PaletteInstallerCA" DllEntry="CreateIniFile" Return="check" HideTarget="yes" Impersonate="no" />    
    <CustomAction Id="HidePaletteUser" Return="check" Execute="deferred" BinaryKey="PaletteInstallerCA" DllEntry="HidePaletteUser"/>
    
    <InstallExecuteSequence>
      <Custom Action="CreatePaletteUser" Before="LaunchConditions">NOT Installed</Custom>
      <Custom Action="CreateIniFileImmediate" Sequence="5000">NOT Installed</Custom>
      <Custom Action="CreateIniFile" Sequence="5001">NOT Installed</Custom>
      <Custom Action="HidePaletteUserImmediate" Sequence="5002">NOT Installed</Custom>
      <Custom Action="HidePaletteUser" Sequence="5003">NOT Installed</Custom>
      <Custom Action="CleanupAfterUnInstall" After="InstallFinalize">(NOT UPGRADINGPRODUCTCODE) AND (REMOVE="ALL")</Custom>
      <Custom Action="CleanupOnRollback" After="InstallInitialize">REMOVE="ALL"</Custom>
    </InstallExecuteSequence>
	</Product>
</Wix>
